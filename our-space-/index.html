<script>
  const $ = (id) => document.getElementById(id);
  const API = "/.netlify/functions";

  function esc(s){ return (s ?? "").toString().replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"); }
  function nl2br(s){ return esc(s).replace(/\n/g,"<br>"); }
  function niceTime(iso){ return new Date(iso).toLocaleString(); }

  function renderCard(row) {
    const titleHtml = row.title ? `<div class="etitle">${esc(row.title)}</div>` : "";
    return `
      <div class="entry"><div class="inner">
        <div class="meta">
          <div class="badges"><b>${esc(row.author || "")}</b> <span class="when">${esc(niceTime(row.created_at))}</span></div>
        </div>
        ${titleHtml}
        <div class="ebody">${nl2br(row.body || "")}</div>
      </div></div>
    `;
  }

  async function loadEntries(section) {
    const list = $(section + "List");
    if (!list) return;
    list.innerHTML = `<p class="empty">Loadingâ€¦</p>`;

    const res = await fetch(`${API}/entries?section=${encodeURIComponent(section)}`);
    const data = await res.json();

    if (!data.ok) {
      list.innerHTML = `<p class="empty">Couldnâ€™t load: ${esc(data.error || "unknown error")}</p>`;
      return;
    }

    const rows = data.entries || [];
    if (!rows.length) {
      list.innerHTML = `<p class="empty">No saved entries yet.</p>`;
      return;
    }
    list.innerHTML = rows.map(renderCard).join("");
  }

  async function saveEntry(section) {
    const author = $(section + "Author")?.value || "AC";
    const title  = ($(section + "Title")?.value || "").trim();
    const body   = ($(section + "Body")?.value || "").trim();

    if (!body) { alert("Write something first ðŸ’›"); return; }

    const res = await fetch(`${API}/entries`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ section, author, title, body })
    });

    const data = await res.json();
    if (!data.ok) {
      alert("Save failed: " + (data.error || "unknown error"));
      return;
    }

    if ($(section + "Title")) $(section + "Title").value = "";
    if ($(section + "Body"))  $(section + "Body").value  = "";

    await loadEntries(section);
  }

  // Hook your buttons to these:
  window.addEntry = (section) => saveEntry(section);

  window.openTab = function(id, btn){
    document.querySelectorAll(".page").forEach(p => p.classList.remove("active"));
    const page = document.getElementById(id);
    if (page) page.classList.add("active");

    document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
    if (btn) btn.classList.add("active");

    // load entries for that tab when opened
    loadEntries(id);
  };

  // initial
  window.addEventListener("load", () => {
    loadEntries("journal");
  });
</script>
